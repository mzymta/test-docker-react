# This config is equivalent to both the '.circleci/extended/orb-free.yml' and the base '.circleci/config.yml'
version: 2.1

persist_to_workspace:
  root: ./
  paths:
    - cache

commands:
  commands:
    restoreImage:
      description: restore docker image from cache
      steps:
        - restore_cache:
            keys:
              - v1-{{ .Branch }}-{{ .Revision }}
            paths:
              - /caches/app.tar
        - run:
            name: Load Docker image layer cache
            command: |
              set +o pipefail
              docker load -i /caches/app.tar | true
    saveImage:
      description: save docker image to cache
      steps:
        - run:
            name: Save Docker image layer cache
            command: |
              mkdir -p /caches
              docker save -o /caches/app.tar app
        - save_cache:
            key: v1-{{ .Branch }}-{{ .Revision }}
            paths:
              - /caches/app.tar

jobs:
  unit_testing:
    docker:
      - image: cimg/node:16.13.2
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
      - run:
          name: Install dependencies
          command: docker build --target deps . -t app
      - saveImage
      - run:
          name: Run tests
          command: docker run app npm run test:ci
  build:
    docker:
      - image: mzymta/react-test
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
      - restoreImage
      - run:
          name: Build
          command: docker build --cache-from=app --target builder . -t app
      - saveImage


# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  pipeline:
    jobs:
      - unit_testing
      - build:
          requires:
            - unit_testing


