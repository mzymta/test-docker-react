# This config is equivalent to both the '.circleci/extended/orb-free.yml' and the base '.circleci/config.yml'
version: 2.1

commands:
  restore_image:
    description: restore docker image from cache
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - setup_remote_docker
      - run:
          name: Load Docker image layer cache
          command: |
            set +o pipefail
            docker load -i /tmp/workspace/app.tar | true
  save_image:
    description: save docker image to cache
    steps:
      - run:
          name: Save Docker image layer cache
          command: docker save -o app.tar app
      - persist_to_workspace:
          root: .
          paths:
            - ./app.tar

jobs:
  unit_testing:
    docker:
      - image: cimg/base:2021.04
    steps:
      - checkout
      - restore_image
      - run:
          name: Install dependencies
          command: docker build --cache-from=app --target deps . -t app
      - run:
          name: LIST THE DIR CONTENT
          command: echo $(ls)
      - save_image
      - run:
          name: Run tests
          command: docker run app npm run test:ci
  build:
    docker:
      - image: cimg/base:2021.04
    steps:
      - checkout
      - restore_image
      - run:
          name: Build
          command: docker build --cache-from=app --target builder . -t app
      - save_image
  build2:
    docker:
      - image: cimg/base:2021.04
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build
          command: docker build --target builder . -t app



# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  pipeline:
    jobs:
      - build2


